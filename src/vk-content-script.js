let tabId;var needInitAudio=!0,audioContext=null,analyser=null,audioElementSource=null,connected=!1,currentElement=null,needInitElement=!0,htmlElementSource=null,vizIndex=0,VisualizerHeight=200,visualizers=[];let COLOR_WHITE={r:255,g:255,b:255},COLOR_BLACK={r:0,g:0,b:0},COLOR_VK={r:81,g:129,b:184},COLOR_LIGHT_BLUE={r:0,g:117,b:255},freqLabels=[16,31,63,125,250,500,1e3,2e3,4e3,8e3,16e3],Visualizations={sinewave:{vktheme:{clearBg:!0,bgColor:COLOR_WHITE,fgColor:COLOR_VK,lineWidth:2},rgbtheme:{clearBg:!0,bgColor:COLOR_BLACK,fgColor:COLOR_LIGHT_BLUE,lineWidth:2}},frequencybars:{vktheme:{clearBg:!0,bgColor:COLOR_WHITE,fgColor:COLOR_VK},rgbtheme:{clearBg:!0,bgColor:COLOR_BLACK}},dancingshapes:{vktheme:{clearBg:!0,bgColor:COLOR_WHITE},rgbtheme:{clearBg:!0,bgColor:COLOR_BLACK}},spectrogram:{vktheme:{clearBg:!1,bgColor:COLOR_BLACK},rgbtheme:{clearBg:!1,bgColor:COLOR_BLACK}},radial:{vktheme:{clearBg:!0,bgColor:COLOR_WHITE},rgbtheme:{clearBg:!0,bgColor:COLOR_BLACK}},lumibars:{vktheme:{clearBg:!0,bgColor:COLOR_WHITE},rgbtheme:{clearBg:!0,bgColor:COLOR_BLACK}},fillzone:{vktheme:{clearBg:!0,bgColor:COLOR_WHITE,lineWidth:4},rgbtheme:{clearBg:!0,bgColor:COLOR_BLACK,lineWidth:4}},led:{vktheme:{clearBg:!0,bgColor:COLOR_WHITE,fgColor:COLOR_VK},rgbtheme:{clearBg:!0,bgColor:COLOR_BLACK}}},DefaultSettings={visType:"frequencybars",theme:"vktheme",useOpacity:!0,minFreq:20,maxFreq:15e3};var globalVars={settings:DefaultSettings,currentBgColor:COLOR_BLACK,currentFgColor:COLOR_WHITE,currentLineWidth:1,frameTime:0,minLog:0,logWidth:0,minIndex:0,maxIndex:0,drawDebug:!1};function pad(e,t){for(e=e.toString();e.length<t;)e="0"+e;return e}function getTimeString(e){var e=Math.floor(e),t=Math.floor(e/3600),a=Math.floor(e/60%60),e=Math.floor(e%60);return t?`${pad(t,2)}:${pad(a,2)}:`+pad(e,2):pad(a,2)+":"+pad(e,2)}function rgbaToHex(e,t,a,r){function n(e){e=e.toString(16);return 1==e.length?"0"+e:e}return"#"+n(e)+n(t)+n(a)+n(r)}function hexToRgba(e){e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16),a:parseInt(e[4],16)}:null}function hexColorToRGBAString(e){e=hexToRgba(e);return`rgba(${e.r}, ${e.g}, ${e.b}, ${e.a})`}function getRGBString(e){return`rgb(${e.r}, ${e.g}, ${e.b})`}function getRGBAString(e,t){return`rgba(${e.r}, ${e.g}, ${e.b}, ${t})`}Inject(),window.onload=InitContent;let getHSLString=function(e,t,a){return"hsl("+e+","+t+"%,"+a+"%)"},HSLToRGB=(t,e,a)=>{a/=100;let r=e=>(e+t/30)%12,n=(e/=100)*Math.min(a,1-a),s=e=>a-n*Math.max(-1,Math.min(r(e)-3,Math.min(9-r(e),1)));return[255*s(0),255*s(8),255*s(4)]};function localize(){document.querySelectorAll("[data-locale]").forEach(e=>{e.innerText=chrome.i18n.getMessage(e.dataset.locale)}),document.querySelectorAll("[title-locale]").forEach(e=>{e.setAttribute("title",chrome.i18n.getMessage(e.getAttribute("title-locale")))})}function RecalcFrequencies(e,t,a){var r=(e,t="round")=>{var a=analyser.frequencyBinCount-1,t=Math[t](e*analyser.fftSize/audioContext.sampleRate);return t<a?t:a};e.minLog=Math.log10(e.settings.minFreq),e.logWidth=t.width/(Math.log10(e.settings.maxFreq)-e.minLog),e.minIndex=r(e.settings.minFreq,"floor"),e.maxIndex=r(e.settings.maxFreq)}function ApplySettings(e,t){e.settings=t,ApplyVisualType(e,t.visType)}function ApplyThemeParams(e,t){var a=Visualizations[e.settings.visType];a?(a=a[t])?(e.settings.theme=t,e.currentBgColor=a.bgColor,e.currentFgColor=a.fgColor,e.currentLineWidth=a.lineWidth,OnSettingsChanged()):console.log("ERROR: Theme "+t+" not found for visual type "+e.settings.visType):console.log("ERROR: Visualization "+e.settings.visType+" not found.")}function ApplyVisualType(e,t){Visualizations[t]?(e.settings.visType=t,ApplyThemeParams(e,e.settings.theme)):console.log("ERROR: Visualization "+t+" not found")}function InitSineWave(e,t){if(analyser.fftSize=256,t.vars.bufferLength=analyser.fftSize,t.vars.dataArray=new Uint8Array(t.vars.bufferLength),t.vars.minFreqThreshold=0,t.vars.maxFreqThreshold=0,"vktheme"===e.settings.theme)t.vars.gradient=t.context.createLinearGradient(0,0,0,t.canvas.height),t.vars.gradient.addColorStop(.2,getRGBString(COLOR_LIGHT_BLUE)),t.vars.gradient.addColorStop(.5,getRGBString(COLOR_VK)),t.vars.gradient.addColorStop(.8,getRGBString(COLOR_LIGHT_BLUE));else if("rgbtheme"===e.settings.theme){t.vars.gradient=t.context.createLinearGradient(0,0,0,t.canvas.height);for(var a=0;a<180;a+=10)t.vars.gradient.addColorStop(a/360,getHSLString(a/180*125,100,50));for(a=180;a<360;a+=10)t.vars.gradient.addColorStop(a/360,getHSLString(125*(1-(a-180)/180),100,50))}}function InitFrequencyBars(e,t){if(analyser.fftSize=256,t.vars.bufferLength=analyser.frequencyBinCount,t.vars.dataArray=new Uint8Array(t.vars.bufferLength),t.vars.minFreqThreshold=0,t.vars.maxFreqThreshold=0,t.vars.barWidth=10,t.vars.barSpace=1,t.vars.numBars=Math.round(t.canvas.width/(t.vars.barWidth+t.vars.barSpace)),t.vars.peaks=new Array(t.vars.numBars).fill().map(e=>({hold:0,y:0,k:0})),t.vars.peakSize=2,"vktheme"===e.settings.theme)t.vars.gradient=t.context.createLinearGradient(0,0,0,t.canvas.height),t.vars.gradient.addColorStop(1,getRGBString(COLOR_VK)),t.vars.gradient.addColorStop(.5,getRGBString(COLOR_LIGHT_BLUE)),t.vars.gradient.addColorStop(0,getRGBString(COLOR_WHITE)),t.vars.getPeakStyle=e=>getRGBString(COLOR_LIGHT_BLUE);else if("rgbtheme"===e.settings.theme){t.vars.gradient=t.context.createLinearGradient(0,0,0,t.canvas.height);for(var a=0;a<360;a+=10)t.vars.gradient.addColorStop(a/360,getHSLString(125*a/360,100,50));t.vars.getPeakStyle=e=>getHSLString(125*(1-e),100,50)}}function InitDancingShapes(e,t){analyser.fftSize=256,t.vars.bufferLength=analyser.frequencyBinCount,t.vars.dataArray=new Uint8Array(t.vars.bufferLength),t.vars.minFreqThreshold=0,t.vars.maxFreqThreshold=0;let a=()=>Math.random()<.5?-1:1,r;null==t.vars.squares&&(t.vars.squares=(r=t.vars.bufferLength,new Array(r).fill().map(e=>({x:Math.random()*t.canvas.width,y:Math.random()*t.canvas.height,size:5+15*Math.random(),scale:1,vx:(10+50*Math.random())*a(),vy:(10+50*Math.random())*a(),percent:0})))),"vktheme"===e.settings.theme?(t.vars.getStrokeStyleFunc=()=>getRGBString(COLOR_LIGHT_BLUE),t.vars.getFillStyleFunc=e=>getHSLString(200,100,75-40*e),t.vars.getCenterFillStyleFunc=e=>getRGBString(COLOR_LIGHT_BLUE)):"rgbtheme"===e.settings.theme&&(t.vars.getStrokeStyleFunc=()=>getHSLString(125,100,50),t.vars.getFillStyleFunc=e=>getHSLString(125*(1-e),100,50),t.vars.getCenterFillStyleFunc=e=>getHSLString(60*(1-e),100,50))}function InitSpectrogram(e,t){t.vars.spectroOffset=0,t.vars.spectroSpeed=25,analyser.fftSize=2048,t.vars.bufferLength=analyser.frequencyBinCount,t.vars.dataArray=new Uint8Array(t.vars.bufferLength),t.vars.minFreqThreshold=0,t.vars.maxFreqThreshold=150,"vktheme"===e.settings.theme?t.vars.getStrokeStyleFunc=e=>getHSLString(200,100,10+70*e):"rgbtheme"===e.settings.theme&&(t.vars.getStrokeStyleFunc=e=>getHSLString(125*(1-e),100,80*e))}function DrawRadialPolygon(e,t,a){a&&(e.fillStyle=a),e.beginPath(),e.moveTo(t.x1,t.y1),e.lineTo(t.x2,t.y2),e.lineTo(t.x3,t.y3),e.lineTo(t.x4,t.y4),e.closePath(),e.fill()}function InitRadial(e,t){if(analyser.fftSize=512,t.vars.bufferDataLength=analyser.frequencyBinCount,t.vars.dataArray=new Uint8Array(t.vars.bufferDataLength),t.vars.contours=[],t.vars.twoPi=2*Math.PI,t.vars.phase=-Math.PI/2,t.vars.numLines=analyser.frequencyBinCount/4,t.vars.radiusX=t.canvas.width/2,t.vars.radiusY=t.canvas.height/2,t.vars.startPercent=.2,t.vars.visiblePercent=.3,t.vars.centerX=t.canvas.width/2,t.vars.centerY=t.canvas.height/2,t.vars.step=t.vars.twoPi/t.vars.numLines,t.vars.contours=new Array(6),t.vars.polygons=new Array(t.vars.twoPi/t.vars.step),t.vars.barAngleWidth=.8*t.vars.step,t.vars.minFreqThreshold=0,t.vars.maxFreqThreshold=0,t.vars.usePolygonStyleFunc=!1,"vktheme"===e.settings.theme)t.vars.gradientFill=t.context.createRadialGradient(t.vars.centerX,t.vars.centerY,50,t.vars.centerX,t.vars.centerY,t.canvas.width),t.vars.gradientFill.addColorStop(0,getRGBString(COLOR_VK)),t.vars.gradientFill.addColorStop(.4,getRGBString(COLOR_LIGHT_BLUE)),t.vars.gradientFill.addColorStop(.8,getRGBString(COLOR_WHITE)),t.vars.getStrokeStyleFunc=()=>t.vars.gradientFill,t.vars.getFillStyleFunc=()=>t.vars.gradientFill,t.vars.getPolygonFunc=e=>{DrawRadialPolygon(t.context,e)};else if("rgbtheme"===e.settings.theme){t.vars.gradientLines=t.context.createRadialGradient(t.vars.centerX,t.vars.centerY,50,t.vars.centerX,t.vars.centerY,t.canvas.width);for(var a=0;a<360;a+=10)t.vars.gradientLines.addColorStop(a/360,getHSLString(120-1.4*a,100,50));for(t.vars.getStrokeStyleFunc=()=>t.vars.gradientLines,t.vars.gradientFill=t.context.createRadialGradient(t.vars.centerX,t.vars.centerY,50,t.vars.centerX,t.vars.centerY,t.canvas.width),a=0;a<360;a+=10)t.vars.gradientFill.addColorStop(a/360,getHSLString(120-1.4*a,100,50));t.vars.getFillStyleFunc=()=>t.vars.gradientFill,t.vars.usePolygonStyleFunc=!0,t.vars.getPolygonFillStyleFunc=e=>getHSLString(e,100,50),t.vars.getPolygonFunc=e=>{DrawRadialPolygon(t.context,e,getHSLString(e.hue,100,50))}}}function InitLumiBars(e,t){analyser.fftSize=256,t.vars.bufferLength=analyser.frequencyBinCount,t.vars.dataArray=new Uint8Array(t.vars.bufferLength),t.vars.minFreqThreshold=0,t.vars.maxFreqThreshold=0,t.vars.barWidth=10,t.vars.barSpace=1,t.vars.numBars=Math.round(t.canvas.width/(t.vars.barWidth+t.vars.barSpace)),t.vars.topPeaks=new Array(t.vars.numBars).fill().map(e=>({hold:0,y:t.canvas.height/2,k:0})),t.vars.bottomPeaks=new Array(t.vars.numBars).fill().map(e=>({hold:0,y:t.canvas.height/2,k:0})),t.vars.peakSize=2,"vktheme"===e.settings.theme?(t.vars.colorCalcFunc=(e,t)=>getHSLString(210,100,50),t.vars.getPeakStyle=e=>getRGBString(COLOR_LIGHT_BLUE)):"rgbtheme"===e.settings.theme&&(t.vars.colorCalcFunc=(e,t)=>getHSLString(e,100,50),t.vars.getPeakStyle=(e,t)=>getHSLString(e,100,50))}function InitFillZone(e,t){if(analyser.fftSize=256,t.vars.bufferLength=analyser.frequencyBinCount,t.vars.dataArray=new Uint8Array(t.vars.bufferLength),t.vars.minFreqThreshold=0,t.vars.maxFreqThreshold=0,"vktheme"===e.settings.theme)t.vars.gradientFill=t.context.createLinearGradient(0,0,0,t.canvas.height),t.vars.gradientFill.addColorStop(1,getRGBString(COLOR_VK)),t.vars.gradientFill.addColorStop(.4,getRGBString(COLOR_LIGHT_BLUE)),t.vars.gradientFill.addColorStop(0,getRGBString(COLOR_WHITE)),t.vars.getStrokeStyleFunc=()=>getRGBString(COLOR_LIGHT_BLUE);else if("rgbtheme"===e.settings.theme){t.vars.gradientFill=t.context.createLinearGradient(0,0,t.canvas.width,0),t.vars.gradientLine=t.context.createLinearGradient(0,0,t.canvas.width,0);for(var a=0;a<360;a+=10)t.vars.gradientFill.addColorStop(a/360,getHSLString(a,100,20)),t.vars.gradientLine.addColorStop(a/360,getHSLString(a,100,50));t.vars.getStrokeStyleFunc=()=>t.vars.gradientLine}}function InitLED(e,t){if(analyser.fftSize=256,t.vars.bufferLength=analyser.frequencyBinCount,t.vars.dataArray=new Uint8Array(t.vars.bufferLength),t.vars.minFreqThreshold=0,t.vars.maxFreqThreshold=0,t.vars.barWidth=10,t.vars.barSpace=1,t.vars.numBars=Math.round(t.canvas.width/(t.vars.barWidth+t.vars.barSpace)),t.vars.cellHeight=5,t.vars.cellSpace=3,t.vars.numCells=Math.round(t.canvas.height/(t.vars.cellHeight+t.vars.cellSpace))+1,t.vars.peaks=new Array(t.vars.numBars).fill().map(e=>({hold:0,y:0,k:0})),t.vars.peakSize=2,"vktheme"===e.settings.theme)t.vars.gradient=t.context.createLinearGradient(0,0,0,t.canvas.height),t.vars.gradient.addColorStop(1,getRGBString(COLOR_VK)),t.vars.gradient.addColorStop(.5,getRGBString(COLOR_LIGHT_BLUE)),t.vars.gradient.addColorStop(0,getRGBString(COLOR_WHITE)),t.vars.getPeakStyle=e=>getRGBString(COLOR_LIGHT_BLUE),t.vars.getOffStyle=()=>getRGBString(COLOR_VK);else if("rgbtheme"===e.settings.theme){t.vars.gradient=t.context.createLinearGradient(0,0,0,t.canvas.height);for(var a=0;a<360;a+=10)t.vars.gradient.addColorStop(a/360,getHSLString(125*a/360,100,50));t.vars.getPeakStyle=e=>getHSLString(125*(1-e),100,50),t.vars.getOffStyle=()=>"rgb(128, 128, 128)"}}function DrawBackground(e,t){var a=Visualizations[e.settings.visType];a&&(a=a[e.settings.theme])&&a.clearBg&&(t.context.fillStyle=getRGBString(e.currentBgColor),t.context.fillRect(0,0,t.canvas.width,t.canvas.height))}function DrawSineWave(e,t){analyser.getByteTimeDomainData(t.vars.dataArray),t.context.strokeStyle=t.vars.gradient,t.context.lineWidth=e.currentLineWidth,t.context.beginPath();for(var a=0;a<5;++a){t.context.moveTo(0,t.canvas.height/2);for(var r=0;r<t.vars.bufferLength;++r){var n=1-t.vars.dataArray[r]/128,s=r/t.vars.bufferLength*t.canvas.width;t.context.lineTo(s,t.canvas.height/2+n*t.canvas.height/2+n*a*80)}t.context.lineTo(t.canvas.width,t.canvas.height/2),t.context.globalAlpha=e.settings.useOpacity?1-a/5:1,t.context.stroke()}t.context.globalAlpha=1}function DrawFrequencyBars(e,t){analyser.getByteFrequencyData(t.vars.dataArray),t.context.fillStyle=t.vars.gradient;for(var a=0;a<t.vars.numBars;++a){var r=e.minIndex+Math.floor(a/t.vars.numBars*(e.maxIndex-e.minIndex)),r=t.vars.dataArray[r]/255,n=t.canvas.height*r,s=a*(t.vars.barWidth+t.vars.barSpace);t.context.globalAlpha=!e.settings.useOpacity||.5<r?1:2*r,t.context.fillRect(s,t.canvas.height-n,t.vars.barWidth,n),(o=t.vars.peaks[a]).k=r,0<=o.y&&(o.hold--,o.hold<=0)&&(o.y+=o.hold),o.y<n&&(o.y=n,o.hold=20)}for(t.context.globalAlpha=1,a=0;a<t.vars.numBars;++a){var o=t.vars.peaks[a];t.context.fillStyle=t.vars.getPeakStyle(o.k);let e=a*(t.vars.barWidth+t.vars.barSpace);t.context.fillRect(e,t.canvas.height-o.y,t.vars.barWidth,t.vars.peakSize)}}function DrawDancingShapes(c,v){analyser.getByteFrequencyData(v.vars.dataArray);for(var e=c.minIndex;e<c.maxIndex-c.minIndex;++e){var t=(value=v.vars.dataArray[e])/255,t=((sq=v.vars.squares[e-c.minIndex]).percent=t,sq.scale=1+2*t,sq.x+sq.vx*c.delta*.001),a=sq.y+sq.vy*c.delta*.001;t<0||t>v.canvas.width?sq.vx*=-1:sq.x=t,a<0||a>v.canvas.height?sq.vy*=-1:sq.y=a}var r=v.vars.squares;v.context.strokeStyle=v.vars.getStrokeStyleFunc(),v.context.lineWidth=2,v.context.globalAlpha=.5,v.context.beginPath(),v.context.moveTo(r[0].x,r[0].y);for(var n,s,o,i,l,g,d,u,h=c.minIndex;h<c.maxIndex;++h){var m=r[h];v.context.lineTo(m.x,m.y)}for(v.context.stroke(),v.context.beginPath(),h=c.minIndex;h<c.maxIndex;++h)(({x:e,y:t,size:a,scale:r,percent:n})=>{v.context.fillStyle=v.vars.getFillStyleFunc(n);for(var s=3;0<=s;--s){var o=r*a+n*s*s*6,i=e-o/2,l=t-o/2;v.context.globalAlpha=c.settings.useOpacity?.6*(1-s/3):1,v.context.fillRect(i,l,o,o)}})(m=r[h]);for(h=c.minIndex;h<c.maxIndex;++h)m=r[h],{x:n,y:s,size:o,scale:i,percent:l}=[m][0],g=u=d=u=d=g=void 0,d=n-(g=i*o)/2,u=s-g/2,v.context.globalAlpha=c.settings.useOpacity?.4+.6*l:1,v.context.fillStyle=v.vars.getFillStyleFunc(l),v.context.fillRect(d,u,g,g),u=n-(d=i*o*.5)/2,g=s-d/2,v.context.globalAlpha=c.settings.useOpacity?.6+.4*l:1,v.context.fillStyle=v.vars.getCenterFillStyleFunc(l),v.context.fillRect(u,g,d,d);v.context.globalAlpha=1}function DrawSpectrogram(t,a){analyser.getByteFrequencyData(a.vars.dataArray);var r=a.canvas.width/(t.maxIndex-t.minIndex),e=a.context.getImageData(0,0,a.canvas.width,a.canvas.height-1);a.context.putImageData(e,0,1);for(let e=t.minIndex;e<t.maxIndex;++e){var n=a.vars.dataArray[e]/255,n=(a.context.strokeStyle=a.vars.getStrokeStyleFunc(n),a.context.beginPath(),(e-t.minIndex)*r);a.context.moveTo(n,0),a.context.lineTo(n+r,0),a.context.stroke()}a.vars.spectroOffset=(a.vars.spectroOffset+a.vars.spectroSpeed*t.delta*.001)%a.canvas.height}function DrawRadial(e,a){analyser.getByteFrequencyData(a.vars.dataArray);for(var t=0;t<a.vars.contours.length;++t)a.vars.contours[t]=[];for(var r=0,n=0;n<a.vars.twoPi;n+=a.vars.step){for(var s=e.minIndex+Math.floor(n/a.vars.twoPi*(e.maxIndex-e.minIndex-1)),o=a.vars.dataArray[s]/255*(1-a.vars.startPercent),i=a.vars.radiusX*Math.cos(a.vars.phase+n)*(a.vars.visiblePercent+o),l=a.vars.radiusY*Math.sin(a.vars.phase+n)*(a.vars.visiblePercent+o),t=0;t<a.vars.contours.length;++t){let e=1+.015*t*t+o;a.vars.contours[t].push({x:a.vars.centerX+i*e,y:a.vars.centerY+l*e})}var s=a.vars.radiusX*Math.cos(a.vars.phase+n+a.vars.barAngleWidth/2)*a.vars.startPercent,c=a.vars.radiusY*Math.sin(a.vars.phase+n+a.vars.barAngleWidth/2)*a.vars.startPercent,v=a.vars.radiusX*Math.cos(a.vars.phase+n-a.vars.barAngleWidth/2)*a.vars.startPercent,g=a.vars.radiusY*Math.sin(a.vars.phase+n-a.vars.barAngleWidth/2)*a.vars.startPercent,d=a.vars.radiusX*Math.cos(a.vars.phase+n+a.vars.barAngleWidth/2)*(a.vars.visiblePercent+o),u=a.vars.radiusY*Math.sin(a.vars.phase+n+a.vars.barAngleWidth/2)*(a.vars.visiblePercent+o),h=a.vars.radiusX*Math.cos(a.vars.phase+n-a.vars.barAngleWidth/2)*(a.vars.visiblePercent+o),m=a.vars.radiusY*Math.sin(a.vars.phase+n-a.vars.barAngleWidth/2)*(a.vars.visiblePercent+o),y=(n-a.vars.phase/32)/a.vars.twoPi*360;a.vars.polygons[r++]={x1:a.vars.centerX+s,y1:a.vars.centerY+c,x2:a.vars.centerX+d,y2:a.vars.centerY+u,x3:a.vars.centerX+h,y3:a.vars.centerY+m,x4:a.vars.centerX+v,y4:a.vars.centerY+g,hue:y}}if(a.vars.dataArray.reduce(function(e,t){return e+t},0)){for(a.context.strokeStyle=a.vars.getStrokeStyleFunc(),a.context.lineWidth=e.currentLineWidth,t=0;t<a.vars.contours.length;t++)if(a.context.globalAlpha=e.settings.useOpacity?1-t/a.vars.contours.length:1,a.vars.contours[t].length){a.context.beginPath(),a.context.moveTo(a.vars.contours[t][0].x,a.vars.contours[t][0].y);for(let e of a.vars.contours[t])a.context.lineTo(e.x,e.y);a.context.stroke(),a.context.closePath()}a.context.globalAlpha=1,a.context.fillStyle=a.vars.getFillStyleFunc(),a.vars.polygons.forEach(function(e,t){a.vars.getPolygonFunc(e)})}}function DrawLumiBars(e,t){analyser.getByteFrequencyData(t.vars.dataArray);for(var a=0;a<t.vars.numBars;++a){var r=e.minIndex+Math.floor(a/t.vars.numBars*(e.maxIndex-e.minIndex)),r=t.vars.dataArray[r]/255,n=Math.floor(a/t.vars.numBars*359),s=t.canvas.height*r;t.context.globalAlpha=e.settings.useOpacity?2*r:1,t.context.fillStyle=t.vars.colorCalcFunc(n,r),t.context.fillRect(a*(t.vars.barWidth+t.vars.barSpace),t.canvas.height/2-s/2,t.vars.barWidth,s),(o=t.vars.topPeaks[a]).k=r,o.y>=t.canvas.height/2&&(o.hold--,o.hold<=0)&&(o.y+=o.hold),t.canvas.height/2+s/2>o.y&&(o.y=t.canvas.height/2+s/2,o.hold=20),(o=t.vars.bottomPeaks[a]).k=r,o.y<=t.canvas.height/2&&(o.hold--,o.hold<=0)&&(o.y-=o.hold),t.canvas.height/2-s/2<o.y&&(o.y=t.canvas.height/2-s/2,o.hold=20)}for(t.context.globalAlpha=1,a=0;a<t.vars.numBars;++a){let e=Math.floor(a/t.vars.numBars*359);t.context.fillStyle=t.vars.getPeakStyle(e,o.k);{var o=t.vars.topPeaks[a];let e=a*(t.vars.barWidth+t.vars.barSpace);t.context.fillRect(e,t.canvas.height-o.y,t.vars.barWidth,t.vars.peakSize)}{o=t.vars.bottomPeaks[a];let e=a*(t.vars.barWidth+t.vars.barSpace);t.context.fillRect(e,t.canvas.height-o.y,t.vars.barWidth,t.vars.peakSize)}}}function DrawFillZone(r,n){analyser.getByteFrequencyData(n.vars.dataArray),n.context.strokeStyle=n.vars.getStrokeStyleFunc(),n.context.lineWidth=r.currentLineWidth,n.context.beginPath(),n.context.moveTo(0,n.canvas.height);for(var s=r.minIndex;s<r.maxIndex;++s){let e=n.vars.dataArray[s]/255,t=n.canvas.height*(1-e),a=(s-r.minIndex)/(r.maxIndex-r.minIndex)*n.canvas.width;n.context.lineTo(a,t)}n.context.lineTo(n.canvas.width,n.canvas.height),n.context.stroke(),n.context.fillStyle=n.vars.gradientFill,n.context.closePath(),n.context.fill(),n.context.beginPath(),n.context.lineWidth=2;for(var e=1;e<5;++e){for(n.context.moveTo(0,n.canvas.height),s=r.minIndex;s<r.maxIndex;++s){var t=n.vars.dataArray[s]/255,t=n.canvas.height*(1-t)-t*e*80,a=(s-r.minIndex)/(r.maxIndex-r.minIndex)*n.canvas.width;n.context.lineTo(a,t)}n.context.lineTo(n.canvas.width,n.canvas.height),n.context.globalAlpha=r.settings.useOpacity?1-e/5:1,n.context.stroke()}n.context.globalAlpha=1}function DrawLED(e,a){analyser.getByteFrequencyData(a.vars.dataArray);for(var r=0;r<a.vars.numBars;++r){var t=e.minIndex+Math.floor(r/a.vars.numBars*(e.maxIndex-e.minIndex)),t=a.vars.dataArray[t]/255,n=a.canvas.height*t,s=r*(a.vars.barWidth+a.vars.barSpace);a.context.globalAlpha=!e.settings.useOpacity||.5<t?1:2*t,a.context.fillStyle=a.vars.gradient;for(var o=0;o<a.vars.numCells;++o){var i=o*(a.vars.cellHeight+a.vars.cellSpace);n<i?(a.context.globalAlpha=.2,a.context.fillStyle=a.vars.getOffStyle()):n<i+a.vars.cellHeight&&(a.context.globalAlpha=1),a.context.fillRect(s,a.canvas.height-i,a.vars.barWidth,a.vars.cellHeight)}(l=a.vars.peaks[r]).k=t,0<=l.y&&(l.hold--,l.hold<=0)&&(l.y+=l.hold),l.y<n&&(l.y=n,l.hold=20)}for(a.context.globalAlpha=1,r=0;r<a.vars.numBars;++r){var l=a.vars.peaks[r];a.context.fillStyle=a.vars.getPeakStyle(l.k);let e=l.y/(a.vars.cellHeight+a.vars.cellSpace)+1,t=r*(a.vars.barWidth+a.vars.barSpace);a.context.fillRect(t,a.canvas.height-e*(a.vars.cellHeight+a.vars.cellSpace),a.vars.barWidth,a.vars.cellHeight)}}var initCallbacks={sinewave:InitSineWave,frequencybars:InitFrequencyBars,dancingshapes:InitDancingShapes,spectrogram:InitSpectrogram,radial:InitRadial,lumibars:InitLumiBars,fillzone:InitFillZone,led:InitLED},drawCallbacks={sinewave:DrawSineWave,frequencybars:DrawFrequencyBars,dancingshapes:DrawDancingShapes,spectrogram:DrawSpectrogram,radial:DrawRadial,lumibars:DrawLumiBars,fillzone:DrawFillZone,led:DrawLED},drawFrequenciesParams={vktheme:{bgColor:"white",textColor:"black"},rgbtheme:{bgColor:"black",textColor:"hsl(125, 100%, 50%)"}};function Draw(t,a){var e=drawCallbacks[t.settings.visType];if(e&&e(t,a),t.settings.drawDebug){fpsTimer+=a.vars.delta,++fpsCounter,1e3<fpsTimer&&(FPS=Math.round(fpsCounter/fpsTimer*1e3),fpsTimer=0,fpsCounter=0);let e=drawFrequenciesParams[t.settings.theme];a.context.fillStyle=e.bgColor,a.context.fillRect(0,a.canvas.height-20,a.canvas.width,20),a.context.fillStyle=e.textColor,a.context.fillText("FPS: "+FPS,5,14);for(let e of freqLabels){var r=1e3<=e?e/1e3+"k":e,n=a.vars.logWidth*(Math.log10(e)-t.minLog);0<=n&&n<=a.canvas.width&&a.context.fillText(r,10+n,a.canvas.height-20+14)}}}var topPlayerParent,DrawAll=function(e,t){var a=Date.now();e.delta=a-e.frameTime,e.frameTime=a,DrawBackground(e,t),analyser&&(t.vars.needInit&&(e.settings.visType||(e.settings.visType=DefaultSettings.visType),console.log("Init visual type "+e.settings.visType),(a=initCallbacks[e.settings.visType])&&a(e,t),RecalcFrequencies(e,t.canvas,t.context),t.vars.needInit=!1),Draw(e,t)),requestAnimationFrame(function(){DrawAll(e,t)})};function DisconnectSourceFromAnalyzer(){audioElementSource&&(audioElementSource.disconnect(),connected=!1)}function ConnectSourceToAnalyzer(){!connected&&audioElementSource&&(audioElementSource.connect(analyser),connected=!0)}function CreateElementSource(e){if(audioElementSource){if(audioElementSource.mediaElement==e)return void console.log("WARNING: source already exists for this element");console.log(`WARNING: Source for other element (id ${audioElementSource.mediaElement.id}) exists and will be destroyed`),DestroyElementSource(),audioElementSource=null}(audioElementSource=audioContext.createMediaElementSource(e)).mediaElement.addEventListener("playing",ConnectSourceToAnalyzer),audioElementSource.mediaElement.addEventListener("emptied",DisconnectSourceFromAnalyzer),ConnectSourceToAnalyzer()}function DestroyElementSource(){audioElementSource?(audioElementSource.mediaElement.removeEventListener("playing",ConnectSourceToAnalyzer),audioElementSource.mediaElement.removeEventListener("emptied",DisconnectSourceFromAnalyzer),audioElementSource.disconnect()):console.log("DestroyElementSource() for null source"),connected=!1}function InitAudio(e){audioContext=new AudioContext,(analyser=audioContext.createAnalyser()).minDecibels=-90,analyser.maxDecibels=-10,analyser.smoothingTimeConstant=.85,analyser.connect(audioContext.destination),audioContext.resume(),e?(CreateElementSource(e),currentElement=e,needInitAudio=!1):console.log("ERROR: no element on init")}function Inject(){var e=document.createElement("script");e.src=chrome.runtime.getURL("page.js"),e.onload=function(){this.remove()},(document.head||document.documentElement).appendChild(e),window.addEventListener("message",function(e){var t;"object"==typeof e.data&&"AUDIO_ELEMENT_EVENT"===(e=e.data).type&&(t=window.document.getElementById(e.audioId),"play"===e.eventType)&&(needInitAudio&&InitAudio(t),currentElement!=t)&&(htmlElementSource!==(currentElement=t).src&&(DestroyElementSource(),audioElementSource=null,htmlElementSource=t.src),CreateElementSource(t))})}function GetControlPanelContent(e){return'\t<div class="custom_combobox">\t\t<label class="custom_combobox_label" for="style_select" data-locale="label_style">Style</label>\t\t<select id="style_select" class="custom_select style_select">\t\t\t<option value="sinewave">Waves</option>\t\t\t<option value="frequencybars">Bars</option>\t\t\t<option value="radial">Radial</option>\t\t\t<option value="lumibars">LumiBars</option>\t\t\t<option value="fillzone">FillZone</option>\t\t\t<option value="led">LED</option>\t\t</select>\t</div>\t<div class="custom_combobox">\t\t<label class="custom_combobox_label" for="theme_select" data-locale="label_theme">Theme</label>\t\t<select id="theme_select" class="custom_select theme_select">\t\t\t<option value="vktheme">VK</option>\t\t\t<option value="rgbtheme">RGB</option>\t\t</select>\t</div>\t<label class="custom_checkbox custom_checkbox_label">\t\t<span data-locale="label_opacity">Opacity</span>\t\t<input type="checkbox" id="switchOpacity" class="opacity_switch" checked="checked">\t\t<span class="checkmark"></span>\t</label>\t<div class="custom_combobox">\t\t<label class="custom_combobox_label" for="range_select_from" data-locale="label_range">Range(Hz)</label>\t\t<br/>\t\t<select class="custom_select range_part_from">\t\t\t<option value="10">10</option>\t\t\t<option value="20">20</option>\t\t\t<option value="50">50</option>\t\t\t<option value="100">100</option>\t\t\t<option value="500">500</option>\t\t\t<option value="1000">1K</option>\t\t\t<option value="5000">5K</option>\t\t\t<option value="10000">10K</option>\t\t\t<option value="15000">15K</option>\t\t\t<option value="20000">20K</option>\t\t\t<option value="22000">22K</option>\t\t</select>\t\t<span style="padding-left: 4px">-</span>\t\t<select class="custom_select range_part_to">\t\t\t<option value="10">10</option>\t\t\t<option value="20">20</option>\t\t\t<option value="50">50</option>\t\t\t<option value="100">100</option>\t\t\t<option value="500">500</option>\t\t\t<option value="1000">1K</option>\t\t\t<option value="5000">5K</option>\t\t\t<option value="10000">10K</option>\t\t\t<option value="15000">15K</option>\t\t\t<option value="20000">20K</option>\t\t\t<option value="22000">22K</option>\t\t</select>\t</div>\t<span class="support_link">\t\t<a target="_blank" rel="noopener noreferrer" href="https://docs.google.com/document/d/1358mdPy5sHWpi-nRCqLnCa3mxB0GN40wF47XrXwLPmA/edit?usp=sharing" data-locale="support_link">Support</a>\t</span>'}function OnChangeOptions(a){visualizers.forEach(function(e){var t;a&&e.element.id==a.element.id||(t=e.index,(e=e.element.querySelector("#control_panel"+t)).querySelector(".style_select").value=globalVars.settings.visType,e.querySelector(".theme_select").value=globalVars.settings.theme,e.querySelector(".opacity_switch").checked=globalVars.settings.useOpacity,e.querySelector(".range_part_from").value=globalVars.settings.minFreq,e.querySelector(".range_part_to").value=globalVars.settings.maxFreq)})}function OnSettingsChanged(){OnChangeOptions(null),visualizers.forEach(function(e){e.vars.needInit=!0}),chrome.runtime.sendMessage({action:"set-settings",settings:globalVars.settings},function(){})}function CreateVisualizer(e){var t=document.createElement("div"),a=(t.id="visualizer_container_"+vizIndex,t.className="visualizer_container",t.setAttribute("style","height:"+VisualizerHeight+"px"),document.createElement("div")),r=(a.id="visualizer"+vizIndex,a.className="visualizer",document.createElement("canvas")),n=(r.id="canvas"+vizIndex,r.className="canvas",r.getContext("2d")),e=(a.appendChild(r),r.width=e.offsetWidth-155,document.createElement("div")),s=(e.id="control_panel"+vizIndex,e.className="control_panel",a.appendChild(e),e.innerHTML=GetControlPanelContent(vizIndex),e.querySelector(".style_select")),s=(s.value=globalVars.settings.visType,s.addEventListener("change",e=>{e=e.currentTarget.value;ApplyVisualType(globalVars,e)}),e.querySelector(".theme_select")),s=(s.value=globalVars.settings.theme,s.addEventListener("change",e=>{e=e.currentTarget.value;ApplyThemeParams(globalVars,e)}),e.querySelector(".opacity_switch")),s=(s.checked=globalVars.settings.useOpacity,s.addEventListener("change",e=>{globalVars.settings.useOpacity=!globalVars.settings.useOpacity,OnSettingsChanged()}),e.querySelector(".range_part_from")),s=(s.value=globalVars.settings.minFreq,s.addEventListener("change",e=>{globalVars.settings.minFreq=parseInt(e.currentTarget.value,10),OnSettingsChanged()}),e.querySelector(".range_part_to")),e=(s.value=globalVars.settings.maxFreq,s.addEventListener("change",e=>{globalVars.settings.maxFreq=parseInt(e.currentTarget.value,10),OnSettingsChanged()}),t.appendChild(a),{index:vizIndex,element:t,canvas:r,context:n,vars:{dataArray:null,bufferLength:0,needInit:!0}});return++vizIndex,DrawAll(globalVars,e),e}var mainPlayerParent,topPlayerObserver=null,attachObserver=null,detachObserver=null;function TryToAttachVisualizer(e,t){return e?null==e.querySelector(".visualizer_container")&&(t=CreateVisualizer(t?e:e=e.querySelector('div[data-testid^="audioplayerblocksectionslayout"]').parentNode),visualizers.push(t),e.insertBefore(t.element,e.firstChild),localize(),!0):(console.error("Player container not found"),!1)}function ObserveMainPlayerDetached(){mainPlayerParent=document.querySelector("#page_body"),detachObserver||(detachObserver=new MutationObserver(function(e){e.forEach(function(e){e.removedNodes.forEach(function(e){e&&e.classList&&e.classList.contains("_audio_page_player_wrap")&&(detachObserver.disconnect(),detachObserver=null,ObserveMainPlayerAttached())})})})).observe(mainPlayerParent,{childList:!0,subtree:!0})}function ObserveMainPlayerAttached(){mainPlayerParent=document.querySelector("#page_body"),attachObserver||(attachObserver=new MutationObserver(function(e){var t=!1;e.forEach(function(e){e.addedNodes.length&&(t=!0)}),t&&(e=mainPlayerParent.querySelector(".AudioPlayerBlock__root"))&&TryToAttachVisualizer(e,!1)&&attachObserver.disconnect()})).observe(mainPlayerParent,{childList:!0,subtree:!0})}function InitContentForTopPlayer(){var a;(topPlayerParent=document.querySelector("#top_audio_layer_place"))?(a=topPlayerParent.querySelector(".audio_layer_container"))?TryToAttachVisualizer(a=a.parentNode,!0):(topPlayerObserver=new MutationObserver(function(e){var t=!1;e.forEach(function(e){e.addedNodes.length&&(t=!0)}),t&&(a=topPlayerParent.querySelector(".audio_layer_container"))&&TryToAttachVisualizer(a=a.parentNode,!0)&&topPlayerObserver.disconnect()})).observe(topPlayerParent,{childList:!0,subtree:!0}):console.error("Failed to find top player place")}function InitContent(){chrome.runtime.sendMessage({action:"query-active-tab"},e=>{tabId=e.id}),chrome.runtime.sendMessage({action:"get-settings"},function(e){ApplySettings(globalVars,e),InitContentForTopPlayer(),ObserveMainPlayerAttached()})}