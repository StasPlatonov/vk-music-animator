let tabId;var needInitAudio=!0,audioContext=null,analyser=null,audioElementSource=null,connected=!1,currentElement=null,needInitElement=!0,htmlElementSource=null,vizIndex=0,VisualizerHeight=200,visualizers=[];const COLOR_WHITE={r:255,g:255,b:255},COLOR_BLACK={r:0,g:0,b:0},COLOR_VK={r:81,g:129,b:184},COLOR_LIGHT_BLUE={r:0,g:117,b:255},freqLabels=[16,31,63,125,250,500,1e3,2e3,4e3,8e3,16e3],Visualizations={sinewave:{vktheme:{clearBg:!0,bgColor:COLOR_WHITE,fgColor:COLOR_VK,lineWidth:2},rgbtheme:{clearBg:!0,bgColor:COLOR_BLACK,fgColor:COLOR_LIGHT_BLUE,lineWidth:2}},frequencybars:{vktheme:{clearBg:!0,bgColor:COLOR_WHITE,fgColor:COLOR_VK},rgbtheme:{clearBg:!0,bgColor:COLOR_BLACK}},dancingshapes:{vktheme:{clearBg:!0,bgColor:COLOR_WHITE},rgbtheme:{clearBg:!0,bgColor:COLOR_BLACK}},spectrogram:{vktheme:{clearBg:!1,bgColor:COLOR_BLACK},rgbtheme:{clearBg:!1,bgColor:COLOR_BLACK}},radial:{vktheme:{clearBg:!0,bgColor:COLOR_WHITE},rgbtheme:{clearBg:!0,bgColor:COLOR_BLACK}},lumibars:{vktheme:{clearBg:!0,bgColor:COLOR_WHITE},rgbtheme:{clearBg:!0,bgColor:COLOR_BLACK}},fillzone:{vktheme:{clearBg:!0,bgColor:COLOR_WHITE,lineWidth:4},rgbtheme:{clearBg:!0,bgColor:COLOR_BLACK,lineWidth:4}},led:{vktheme:{clearBg:!0,bgColor:COLOR_WHITE,fgColor:COLOR_VK},rgbtheme:{clearBg:!0,bgColor:COLOR_BLACK}}},DefaultSettings={visType:"frequencybars",theme:"vktheme",useOpacity:!0,minFreq:20,maxFreq:15e3};var globalVars={settings:DefaultSettings,currentBgColor:COLOR_BLACK,currentFgColor:COLOR_WHITE,currentLineWidth:1,frameTime:0,minLog:0,logWidth:0,minIndex:0,maxIndex:0,drawDebug:!1};function pad(e,t){for(e=e.toString();e.length<t;)e="0"+e;return e}function getTimeString(e){const t=Math.floor(e),a=Math.floor(t/3600),r=Math.floor(t/60%60),n=Math.floor(t%60);return a?`${pad(a,2)}:${pad(r,2)}:${pad(n,2)}`:`${pad(r,2)}:${pad(n,2)}`}function rgbaToHex(e,t,a,r){function n(e){var t=e.toString(16);return 1==t.length?"0"+t:t}return"#"+n(e)+n(t)+n(a)+n(r)}function hexToRgba(e){var t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16),a:parseInt(t[4],16)}:null}function hexColorToRGBAString(e){const t=hexToRgba(e);return`rgba(${t.r}, ${t.g}, ${t.b}, ${t.a})`}function getRGBString(e){return`rgb(${e.r}, ${e.g}, ${e.b})`}function getRGBAString(e,t){return`rgba(${e.r}, ${e.g}, ${e.b}, ${t})`}Inject(),window.onload=InitContent;const getHSLString=function(e,t,a){"use strict";return"hsl("+e+","+t+"%,"+a+"%)"},HSLToRGB=(e,t,a)=>{a/=100;const r=t=>(t+e/30)%12,n=(t/=100)*Math.min(a,1-a),s=e=>a-n*Math.max(-1,Math.min(r(e)-3,Math.min(9-r(e),1)));return[255*s(0),255*s(8),255*s(4)]};function localize(){document.querySelectorAll("[data-locale]").forEach((e=>{e.innerText=chrome.i18n.getMessage(e.dataset.locale)})),document.querySelectorAll("[title-locale]").forEach((e=>{e.setAttribute("title",chrome.i18n.getMessage(e.getAttribute("title-locale")))}))}function RecalcFrequencies(e,t,a){const r=(e,t="round")=>{const a=analyser.frequencyBinCount-1,r=Math[t](e*analyser.fftSize/audioContext.sampleRate);return r<a?r:a};e.minLog=Math.log10(e.settings.minFreq),e.logWidth=t.width/(Math.log10(e.settings.maxFreq)-e.minLog),e.minIndex=r(e.settings.minFreq,"floor"),e.maxIndex=r(e.settings.maxFreq)}function ApplySettings(e,t){e.settings=t,ApplyVisualType(e,t.visType)}function ApplyThemeParams(e,t){var a=Visualizations[e.settings.visType];if(a){var r=a[t];r?(e.settings.theme=t,e.currentBgColor=r.bgColor,e.currentFgColor=r.fgColor,e.currentLineWidth=r.lineWidth,OnSettingsChanged()):console.log("ERROR: Theme "+t+" not found for visual type "+e.settings.visType)}else console.log("ERROR: Visualization "+e.settings.visType+" not found.")}function ApplyVisualType(e,t){Visualizations[t]?(e.settings.visType=t,ApplyThemeParams(e,e.settings.theme)):console.log("ERROR: Visualization "+t+" not found")}function InitSineWave(e,t){if(analyser.fftSize=256,t.vars.bufferLength=analyser.fftSize,t.vars.dataArray=new Uint8Array(t.vars.bufferLength),t.vars.minFreqThreshold=0,t.vars.maxFreqThreshold=0,"vktheme"===e.settings.theme)t.vars.gradient=t.context.createLinearGradient(0,0,0,t.canvas.height),t.vars.gradient.addColorStop(.2,getRGBString(COLOR_LIGHT_BLUE)),t.vars.gradient.addColorStop(.5,getRGBString(COLOR_VK)),t.vars.gradient.addColorStop(.8,getRGBString(COLOR_LIGHT_BLUE));else if("rgbtheme"===e.settings.theme){t.vars.gradient=t.context.createLinearGradient(0,0,0,t.canvas.height);for(var a=0;a<180;a+=10)t.vars.gradient.addColorStop(a/360,getHSLString(a/180*125,100,50));for(a=180;a<360;a+=10)t.vars.gradient.addColorStop(a/360,getHSLString(125*(1-(a-180)/180),100,50))}}function InitFrequencyBars(e,t){if(analyser.fftSize=256,t.vars.bufferLength=analyser.frequencyBinCount,t.vars.dataArray=new Uint8Array(t.vars.bufferLength),t.vars.minFreqThreshold=0,t.vars.maxFreqThreshold=0,t.vars.barWidth=10,t.vars.barSpace=1,t.vars.numBars=Math.round(t.canvas.width/(t.vars.barWidth+t.vars.barSpace)),t.vars.peaks=new Array(t.vars.numBars).fill().map((e=>({hold:0,y:0,k:0}))),t.vars.peakSize=2,"vktheme"===e.settings.theme)t.vars.gradient=t.context.createLinearGradient(0,0,0,t.canvas.height),t.vars.gradient.addColorStop(1,getRGBString(COLOR_VK)),t.vars.gradient.addColorStop(.5,getRGBString(COLOR_LIGHT_BLUE)),t.vars.gradient.addColorStop(0,getRGBString(COLOR_WHITE)),t.vars.getPeakStyle=e=>getRGBString(COLOR_LIGHT_BLUE);else if("rgbtheme"===e.settings.theme){t.vars.gradient=t.context.createLinearGradient(0,0,0,t.canvas.height);for(var a=0;a<360;a+=10)t.vars.gradient.addColorStop(a/360,getHSLString(125*a/360,100,50));t.vars.getPeakStyle=e=>getHSLString(125*(1-e),100,50)}}function InitDancingShapes(e,t){analyser.fftSize=256,t.vars.bufferLength=analyser.frequencyBinCount,t.vars.dataArray=new Uint8Array(t.vars.bufferLength),t.vars.minFreqThreshold=0,t.vars.maxFreqThreshold=0;const a=()=>Math.random()<.5?-1:1;var r;null==t.vars.squares&&(t.vars.squares=(r=t.vars.bufferLength,new Array(r).fill().map((e=>({x:Math.random()*t.canvas.width,y:Math.random()*t.canvas.height,size:5+15*Math.random(),scale:1,vx:(10+50*Math.random())*a(),vy:(10+50*Math.random())*a(),percent:0}))))),"vktheme"===e.settings.theme?(t.vars.getStrokeStyleFunc=()=>getRGBString(COLOR_LIGHT_BLUE),t.vars.getFillStyleFunc=e=>getHSLString(200,100,75-40*e),t.vars.getCenterFillStyleFunc=e=>getRGBString(COLOR_LIGHT_BLUE)):"rgbtheme"===e.settings.theme&&(t.vars.getStrokeStyleFunc=()=>getHSLString(125,100,50),t.vars.getFillStyleFunc=e=>getHSLString(125*(1-e),100,50),t.vars.getCenterFillStyleFunc=e=>getHSLString(60*(1-e),100,50))}function InitSpectrogram(e,t){t.vars.spectroOffset=0,t.vars.spectroSpeed=25,analyser.fftSize=2048,t.vars.bufferLength=analyser.frequencyBinCount,t.vars.dataArray=new Uint8Array(t.vars.bufferLength),t.vars.minFreqThreshold=0,t.vars.maxFreqThreshold=150,"vktheme"===e.settings.theme?t.vars.getStrokeStyleFunc=e=>getHSLString(200,100,10+70*e):"rgbtheme"===e.settings.theme&&(t.vars.getStrokeStyleFunc=e=>getHSLString(125*(1-e),100,80*e))}function DrawRadialPolygon(e,t,a){a&&(e.fillStyle=a),e.beginPath(),e.moveTo(t.x1,t.y1),e.lineTo(t.x2,t.y2),e.lineTo(t.x3,t.y3),e.lineTo(t.x4,t.y4),e.closePath(),e.fill()}function InitRadial(e,t){if(analyser.fftSize=512,t.vars.bufferDataLength=analyser.frequencyBinCount,t.vars.dataArray=new Uint8Array(t.vars.bufferDataLength),t.vars.contours=[],t.vars.twoPi=2*Math.PI,t.vars.phase=-Math.PI/2,t.vars.numLines=analyser.frequencyBinCount/4,t.vars.radiusX=t.canvas.width/2,t.vars.radiusY=t.canvas.height/2,t.vars.startPercent=.2,t.vars.visiblePercent=.3,t.vars.centerX=t.canvas.width/2,t.vars.centerY=t.canvas.height/2,t.vars.step=t.vars.twoPi/t.vars.numLines,t.vars.contours=new Array(6),t.vars.polygons=new Array(t.vars.twoPi/t.vars.step),t.vars.barAngleWidth=.8*t.vars.step,t.vars.minFreqThreshold=0,t.vars.maxFreqThreshold=0,t.vars.usePolygonStyleFunc=!1,"vktheme"===e.settings.theme)t.vars.gradientFill=t.context.createRadialGradient(t.vars.centerX,t.vars.centerY,50,t.vars.centerX,t.vars.centerY,t.canvas.width),t.vars.gradientFill.addColorStop(0,getRGBString(COLOR_VK)),t.vars.gradientFill.addColorStop(.4,getRGBString(COLOR_LIGHT_BLUE)),t.vars.gradientFill.addColorStop(.8,getRGBString(COLOR_WHITE)),t.vars.getStrokeStyleFunc=()=>t.vars.gradientFill,t.vars.getFillStyleFunc=()=>t.vars.gradientFill,t.vars.getPolygonFunc=e=>{DrawRadialPolygon(t.context,e)};else if("rgbtheme"===e.settings.theme){t.vars.gradientLines=t.context.createRadialGradient(t.vars.centerX,t.vars.centerY,50,t.vars.centerX,t.vars.centerY,t.canvas.width);for(var a=0;a<360;a+=10)t.vars.gradientLines.addColorStop(a/360,getHSLString(120-1.4*a,100,50));t.vars.getStrokeStyleFunc=()=>t.vars.gradientLines,t.vars.gradientFill=t.context.createRadialGradient(t.vars.centerX,t.vars.centerY,50,t.vars.centerX,t.vars.centerY,t.canvas.width);for(a=0;a<360;a+=10)t.vars.gradientFill.addColorStop(a/360,getHSLString(120-1.4*a,100,50));t.vars.getFillStyleFunc=()=>t.vars.gradientFill,t.vars.usePolygonStyleFunc=!0,t.vars.getPolygonFillStyleFunc=e=>getHSLString(e,100,50),t.vars.getPolygonFunc=e=>{DrawRadialPolygon(t.context,e,getHSLString(e.hue,100,50))}}}function InitLumiBars(e,t){analyser.fftSize=256,t.vars.bufferLength=analyser.frequencyBinCount,t.vars.dataArray=new Uint8Array(t.vars.bufferLength),t.vars.minFreqThreshold=0,t.vars.maxFreqThreshold=0,t.vars.barWidth=10,t.vars.barSpace=1,t.vars.numBars=Math.round(t.canvas.width/(t.vars.barWidth+t.vars.barSpace)),t.vars.topPeaks=new Array(t.vars.numBars).fill().map((e=>({hold:0,y:t.canvas.height/2,k:0}))),t.vars.bottomPeaks=new Array(t.vars.numBars).fill().map((e=>({hold:0,y:t.canvas.height/2,k:0}))),t.vars.peakSize=2,"vktheme"===e.settings.theme?(t.vars.colorCalcFunc=(e,t)=>getHSLString(210,100,50),t.vars.getPeakStyle=e=>getRGBString(COLOR_LIGHT_BLUE)):"rgbtheme"===e.settings.theme&&(t.vars.colorCalcFunc=(e,t)=>getHSLString(e,100,50),t.vars.getPeakStyle=(e,t)=>getHSLString(e,100,50))}function InitFillZone(e,t){if(analyser.fftSize=256,t.vars.bufferLength=analyser.frequencyBinCount,t.vars.dataArray=new Uint8Array(t.vars.bufferLength),t.vars.minFreqThreshold=0,t.vars.maxFreqThreshold=0,"vktheme"===e.settings.theme)t.vars.gradientFill=t.context.createLinearGradient(0,0,0,t.canvas.height),t.vars.gradientFill.addColorStop(1,getRGBString(COLOR_VK)),t.vars.gradientFill.addColorStop(.4,getRGBString(COLOR_LIGHT_BLUE)),t.vars.gradientFill.addColorStop(0,getRGBString(COLOR_WHITE)),t.vars.getStrokeStyleFunc=()=>getRGBString(COLOR_LIGHT_BLUE);else if("rgbtheme"===e.settings.theme){t.vars.gradientFill=t.context.createLinearGradient(0,0,t.canvas.width,0),t.vars.gradientLine=t.context.createLinearGradient(0,0,t.canvas.width,0);for(var a=0;a<360;a+=10)t.vars.gradientFill.addColorStop(a/360,getHSLString(a,100,20)),t.vars.gradientLine.addColorStop(a/360,getHSLString(a,100,50));t.vars.getStrokeStyleFunc=()=>t.vars.gradientLine}}function InitLED(e,t){if(analyser.fftSize=256,t.vars.bufferLength=analyser.frequencyBinCount,t.vars.dataArray=new Uint8Array(t.vars.bufferLength),t.vars.minFreqThreshold=0,t.vars.maxFreqThreshold=0,t.vars.barWidth=10,t.vars.barSpace=1,t.vars.numBars=Math.round(t.canvas.width/(t.vars.barWidth+t.vars.barSpace)),t.vars.cellHeight=5,t.vars.cellSpace=3,t.vars.numCells=Math.round(t.canvas.height/(t.vars.cellHeight+t.vars.cellSpace))+1,t.vars.peaks=new Array(t.vars.numBars).fill().map((e=>({hold:0,y:0,k:0}))),t.vars.peakSize=2,"vktheme"===e.settings.theme)t.vars.gradient=t.context.createLinearGradient(0,0,0,t.canvas.height),t.vars.gradient.addColorStop(1,getRGBString(COLOR_VK)),t.vars.gradient.addColorStop(.5,getRGBString(COLOR_LIGHT_BLUE)),t.vars.gradient.addColorStop(0,getRGBString(COLOR_WHITE)),t.vars.getPeakStyle=e=>getRGBString(COLOR_LIGHT_BLUE),t.vars.getOffStyle=()=>getRGBString(COLOR_VK);else if("rgbtheme"===e.settings.theme){t.vars.gradient=t.context.createLinearGradient(0,0,0,t.canvas.height);for(var a=0;a<360;a+=10)t.vars.gradient.addColorStop(a/360,getHSLString(125*a/360,100,50));t.vars.getPeakStyle=e=>getHSLString(125*(1-e),100,50),t.vars.getOffStyle=()=>"rgb(128, 128, 128)"}}function DrawBackground(e,t){const a=Visualizations[e.settings.visType];if(!a)return;const r=a[e.settings.theme];r&&r.clearBg&&(t.context.fillStyle=getRGBString(e.currentBgColor),t.context.fillRect(0,0,t.canvas.width,t.canvas.height))}function DrawSineWave(e,t){analyser.getByteTimeDomainData(t.vars.dataArray),t.context.strokeStyle=t.vars.gradient,t.context.lineWidth=e.currentLineWidth,t.context.beginPath();for(var a=0;a<5;++a){t.context.moveTo(0,t.canvas.height/2);for(var r=0;r<t.vars.bufferLength;++r){var n=1-t.vars.dataArray[r]/128,s=r/t.vars.bufferLength*t.canvas.width;t.context.lineTo(s,t.canvas.height/2+n*t.canvas.height/2+n*a*80)}t.context.lineTo(t.canvas.width,t.canvas.height/2),t.context.globalAlpha=e.settings.useOpacity?1-a/5:1,t.context.stroke()}t.context.globalAlpha=1}function DrawFrequencyBars(e,t){analyser.getByteFrequencyData(t.vars.dataArray),t.context.fillStyle=t.vars.gradient;for(var a=0;a<t.vars.numBars;++a){const n=e.minIndex+Math.floor(a/t.vars.numBars*(e.maxIndex-e.minIndex)),s=t.vars.dataArray[n]/255,o=t.canvas.height*s,i=a*(t.vars.barWidth+t.vars.barSpace);t.context.globalAlpha=e.settings.useOpacity?s>.5?1:2*s:1,t.context.fillRect(i,t.canvas.height-o,t.vars.barWidth,o),(r=t.vars.peaks[a]).k=s,r.y>=0&&(r.hold--,r.hold<=0&&(r.y+=r.hold)),o>r.y&&(r.y=o,r.hold=20)}t.context.globalAlpha=1;for(a=0;a<t.vars.numBars;++a){var r=t.vars.peaks[a];t.context.fillStyle=t.vars.getPeakStyle(r.k);const e=a*(t.vars.barWidth+t.vars.barSpace);t.context.fillRect(e,t.canvas.height-r.y,t.vars.barWidth,t.vars.peakSize)}}function DrawDancingShapes(e,t){const a=({x:a,y:r,size:n,scale:s,percent:o})=>{const i=s*n,l=a-i/2,c=r-i/2;t.context.globalAlpha=e.settings.useOpacity?.4+.6*o:1,t.context.fillStyle=t.vars.getFillStyleFunc(o),t.context.fillRect(l,c,i,i);const v=s*n*.5,g=a-v/2,d=r-v/2;t.context.globalAlpha=e.settings.useOpacity?.6+.4*o:1,t.context.fillStyle=t.vars.getCenterFillStyleFunc(o),t.context.fillRect(g,d,v,v)},r=({x:a,y:r,size:n,scale:s,percent:o})=>{t.context.fillStyle=t.vars.getFillStyleFunc(o);for(var i=3;i>=0;--i){const l=s*n+o*i*i*6,c=a-l/2,v=r-l/2;t.context.globalAlpha=e.settings.useOpacity?.6*(1-i/3):1,t.context.fillRect(c,v,l,l)}};analyser.getByteFrequencyData(t.vars.dataArray),function(){for(var a=e.minIndex;a<e.maxIndex-e.minIndex;++a){value=t.vars.dataArray[a];const s=value/255,o=a-e.minIndex;sq=t.vars.squares[o],sq.percent=s,sq.scale=1+2*s;var r=sq.x+sq.vx*e.delta*.001,n=sq.y+sq.vy*e.delta*.001;r<0||r>t.canvas.width?sq.vx*=-1:sq.x=r,n<0||n>t.canvas.height?sq.vy*=-1:sq.y=n}}(),(n=>{t.context.strokeStyle=t.vars.getStrokeStyleFunc(),t.context.lineWidth=2,t.context.globalAlpha=.5,t.context.beginPath(),t.context.moveTo(n[0].x,n[0].y);for(var s=e.minIndex;s<e.maxIndex;++s){var o=n[s];t.context.lineTo(o.x,o.y)}t.context.stroke(),t.context.beginPath();for(s=e.minIndex;s<e.maxIndex;++s){o=n[s];r(o)}for(s=e.minIndex;s<e.maxIndex;++s){o=n[s];a(o)}t.context.globalAlpha=1})(t.vars.squares)}function DrawSpectrogram(e,t){analyser.getByteFrequencyData(t.vars.dataArray);const a=t.canvas.width/(e.maxIndex-e.minIndex);let r=t.context.getImageData(0,0,t.canvas.width,t.canvas.height-1);t.context.putImageData(r,0,1);for(let r=e.minIndex;r<e.maxIndex;++r){const n=t.vars.dataArray[r]/255;t.context.strokeStyle=t.vars.getStrokeStyleFunc(n),t.context.beginPath();const s=(r-e.minIndex)*a;t.context.moveTo(s,0),t.context.lineTo(s+a,0),t.context.stroke()}t.vars.spectroOffset=(t.vars.spectroOffset+t.vars.spectroSpeed*e.delta*.001)%t.canvas.height}function DrawRadial(e,t){analyser.getByteFrequencyData(t.vars.dataArray);for(var a=0;a<t.vars.contours.length;++a)t.vars.contours[a]=[];for(var r=0,n=0;n<t.vars.twoPi;n+=t.vars.step){var s=e.minIndex+Math.floor(n/t.vars.twoPi*(e.maxIndex-e.minIndex-1)),o=t.vars.dataArray[s]/255*(1-t.vars.startPercent),i=t.vars.radiusX*Math.cos(t.vars.phase+n)*(t.vars.visiblePercent+o),l=t.vars.radiusY*Math.sin(t.vars.phase+n)*(t.vars.visiblePercent+o);for(a=0;a<t.vars.contours.length;++a){const e=1+.015*a*a+o;t.vars.contours[a].push({x:t.vars.centerX+i*e,y:t.vars.centerY+l*e})}var c=t.vars.radiusX*Math.cos(t.vars.phase+n+t.vars.barAngleWidth/2)*t.vars.startPercent,v=t.vars.radiusY*Math.sin(t.vars.phase+n+t.vars.barAngleWidth/2)*t.vars.startPercent,g=t.vars.radiusX*Math.cos(t.vars.phase+n-t.vars.barAngleWidth/2)*t.vars.startPercent,d=t.vars.radiusY*Math.sin(t.vars.phase+n-t.vars.barAngleWidth/2)*t.vars.startPercent,u=t.vars.radiusX*Math.cos(t.vars.phase+n+t.vars.barAngleWidth/2)*(t.vars.visiblePercent+o),h=t.vars.radiusY*Math.sin(t.vars.phase+n+t.vars.barAngleWidth/2)*(t.vars.visiblePercent+o),m=t.vars.radiusX*Math.cos(t.vars.phase+n-t.vars.barAngleWidth/2)*(t.vars.visiblePercent+o),y=t.vars.radiusY*Math.sin(t.vars.phase+n-t.vars.barAngleWidth/2)*(t.vars.visiblePercent+o);const p=(n-t.vars.phase/32)/t.vars.twoPi*360;t.vars.polygons[r++]={x1:t.vars.centerX+c,y1:t.vars.centerY+v,x2:t.vars.centerX+u,y2:t.vars.centerY+h,x3:t.vars.centerX+m,y3:t.vars.centerY+y,x4:t.vars.centerX+g,y4:t.vars.centerY+d,hue:p}}if(t.vars.dataArray.reduce((function(e,t){return e+t}),0)){t.context.strokeStyle=t.vars.getStrokeStyleFunc(),t.context.lineWidth=e.currentLineWidth;for(a=0;a<t.vars.contours.length;a++)if(t.context.globalAlpha=e.settings.useOpacity?1-a/t.vars.contours.length:1,t.vars.contours[a].length){t.context.beginPath(),t.context.moveTo(t.vars.contours[a][0].x,t.vars.contours[a][0].y);for(const e of t.vars.contours[a])t.context.lineTo(e.x,e.y);t.context.stroke(),t.context.closePath()}t.context.globalAlpha=1,t.context.fillStyle=t.vars.getFillStyleFunc(),t.vars.polygons.forEach((function(e,a){t.vars.getPolygonFunc(e)}))}}function DrawLumiBars(e,t){analyser.getByteFrequencyData(t.vars.dataArray);for(var a=0;a<t.vars.numBars;++a){const n=e.minIndex+Math.floor(a/t.vars.numBars*(e.maxIndex-e.minIndex)),s=t.vars.dataArray[n]/255,o=Math.floor(a/t.vars.numBars*359),i=t.canvas.height*s;t.context.globalAlpha=e.settings.useOpacity?2*s:1,t.context.fillStyle=t.vars.colorCalcFunc(o,s),t.context.fillRect(a*(t.vars.barWidth+t.vars.barSpace),t.canvas.height/2-i/2,t.vars.barWidth,i),(r=t.vars.topPeaks[a]).k=s,r.y>=t.canvas.height/2&&(r.hold--,r.hold<=0&&(r.y+=r.hold)),t.canvas.height/2+i/2>r.y&&(r.y=t.canvas.height/2+i/2,r.hold=20),(r=t.vars.bottomPeaks[a]).k=s,r.y<=t.canvas.height/2&&(r.hold--,r.hold<=0&&(r.y-=r.hold)),t.canvas.height/2-i/2<r.y&&(r.y=t.canvas.height/2-i/2,r.hold=20)}t.context.globalAlpha=1;for(a=0;a<t.vars.numBars;++a){const e=Math.floor(a/t.vars.numBars*359);t.context.fillStyle=t.vars.getPeakStyle(e,r.k);{var r=t.vars.topPeaks[a];const e=a*(t.vars.barWidth+t.vars.barSpace);t.context.fillRect(e,t.canvas.height-r.y,t.vars.barWidth,t.vars.peakSize)}{r=t.vars.bottomPeaks[a];const e=a*(t.vars.barWidth+t.vars.barSpace);t.context.fillRect(e,t.canvas.height-r.y,t.vars.barWidth,t.vars.peakSize)}}}function DrawFillZone(e,t){analyser.getByteFrequencyData(t.vars.dataArray),t.context.strokeStyle=t.vars.getStrokeStyleFunc(),t.context.lineWidth=e.currentLineWidth,t.context.beginPath(),t.context.moveTo(0,t.canvas.height);for(var a=e.minIndex;a<e.maxIndex;++a){const r=t.vars.dataArray[a]/255,n=t.canvas.height*(1-r),s=(a-e.minIndex)/(e.maxIndex-e.minIndex)*t.canvas.width;t.context.lineTo(s,n)}t.context.lineTo(t.canvas.width,t.canvas.height),t.context.stroke(),t.context.fillStyle=t.vars.gradientFill,t.context.closePath(),t.context.fill(),t.context.beginPath(),t.context.lineWidth=2;for(var r=1;r<5;++r){t.context.moveTo(0,t.canvas.height);for(a=e.minIndex;a<e.maxIndex;++a){const n=t.vars.dataArray[a]/255,s=t.canvas.height*(1-n)-n*r*80,o=(a-e.minIndex)/(e.maxIndex-e.minIndex)*t.canvas.width;t.context.lineTo(o,s)}t.context.lineTo(t.canvas.width,t.canvas.height),t.context.globalAlpha=e.settings.useOpacity?1-r/5:1,t.context.stroke()}t.context.globalAlpha=1}function DrawLED(e,t){analyser.getByteFrequencyData(t.vars.dataArray);for(var a=0;a<t.vars.numBars;++a){const o=e.minIndex+Math.floor(a/t.vars.numBars*(e.maxIndex-e.minIndex)),i=t.vars.dataArray[o]/255,l=t.canvas.height*i,c=a*(t.vars.barWidth+t.vars.barSpace);t.context.globalAlpha=e.settings.useOpacity?i>.5?1:2*i:1,t.context.fillStyle=t.vars.gradient;for(var r=0;r<t.vars.numCells;++r){var n=r*(t.vars.cellHeight+t.vars.cellSpace);l<n?(t.context.globalAlpha=.2,t.context.fillStyle=t.vars.getOffStyle(),t.context.fillRect(c,t.canvas.height-n,t.vars.barWidth,t.vars.cellHeight)):(l<n+t.vars.cellHeight&&(t.context.globalAlpha=1),t.context.fillRect(c,t.canvas.height-n,t.vars.barWidth,t.vars.cellHeight))}(s=t.vars.peaks[a]).k=i,s.y>=0&&(s.hold--,s.hold<=0&&(s.y+=s.hold)),l>s.y&&(s.y=l,s.hold=20)}t.context.globalAlpha=1;for(a=0;a<t.vars.numBars;++a){var s=t.vars.peaks[a];t.context.fillStyle=t.vars.getPeakStyle(s.k);const e=s.y/(t.vars.cellHeight+t.vars.cellSpace)+1,r=a*(t.vars.barWidth+t.vars.barSpace);t.context.fillRect(r,t.canvas.height-e*(t.vars.cellHeight+t.vars.cellSpace),t.vars.barWidth,t.vars.cellHeight)}}var initCallbacks={sinewave:InitSineWave,frequencybars:InitFrequencyBars,dancingshapes:InitDancingShapes,spectrogram:InitSpectrogram,radial:InitRadial,lumibars:InitLumiBars,fillzone:InitFillZone,led:InitLED},drawCallbacks={sinewave:DrawSineWave,frequencybars:DrawFrequencyBars,dancingshapes:DrawDancingShapes,spectrogram:DrawSpectrogram,radial:DrawRadial,lumibars:DrawLumiBars,fillzone:DrawFillZone,led:DrawLED},drawFrequenciesParams={vktheme:{bgColor:"white",textColor:"black"},rgbtheme:{bgColor:"black",textColor:"hsl(125, 100%, 50%)"}};function Draw(e,t){var a=drawCallbacks[e.settings.visType];if(a&&a(e,t),e.settings.drawDebug){fpsTimer+=t.vars.delta,++fpsCounter,fpsTimer>1e3&&(FPS=Math.round(fpsCounter/fpsTimer*1e3),fpsTimer=0,fpsCounter=0);const a=drawFrequenciesParams[e.settings.theme];t.context.fillStyle=a.bgColor,t.context.fillRect(0,t.canvas.height-20,t.canvas.width,20),t.context.fillStyle=a.textColor,t.context.fillText(`FPS: ${FPS}`,5,14);for(const a of freqLabels){const r=a>=1e3?a/1e3+"k":a,n=t.vars.logWidth*(Math.log10(a)-e.minLog);n>=0&&n<=t.canvas.width&&t.context.fillText(r,10+n,t.canvas.height-20+14)}}}var topPlayerParent,DrawAll=function(e,t){const a=Date.now();if(e.delta=a-e.frameTime,e.frameTime=a,DrawBackground(e,t),analyser){if(t.vars.needInit){e.settings.visType||(e.settings.visType=DefaultSettings.visType),console.log("Init visual type "+e.settings.visType);var r=initCallbacks[e.settings.visType];r&&r(e,t),RecalcFrequencies(e,t.canvas,t.context),t.vars.needInit=!1}Draw(e,t)}requestAnimationFrame((function(){DrawAll(e,t)}))};function DisconnectSourceFromAnalyzer(){audioElementSource&&(audioElementSource.disconnect(),connected=!1)}function ConnectSourceToAnalyzer(){!connected&&audioElementSource&&(audioElementSource.connect(analyser),connected=!0)}function CreateElementSource(e){if(audioElementSource){if(audioElementSource.mediaElement==e)return void console.log("WARNING: source already exists for this element");console.log(`WARNING: Source for other element (id ${audioElementSource.mediaElement.id}) exists and will be destroyed`),DestroyElementSource(),audioElementSource=null}(audioElementSource=audioContext.createMediaElementSource(e)).mediaElement.addEventListener("playing",ConnectSourceToAnalyzer),audioElementSource.mediaElement.addEventListener("emptied",DisconnectSourceFromAnalyzer),ConnectSourceToAnalyzer()}function DestroyElementSource(){audioElementSource?(audioElementSource.mediaElement.removeEventListener("playing",ConnectSourceToAnalyzer),audioElementSource.mediaElement.removeEventListener("emptied",DisconnectSourceFromAnalyzer),audioElementSource.disconnect()):console.log("DestroyElementSource() for null source"),connected=!1}function InitAudio(e){audioContext=new AudioContext,(analyser=audioContext.createAnalyser()).minDecibels=-90,analyser.maxDecibels=-10,analyser.smoothingTimeConstant=.85,analyser.connect(audioContext.destination),audioContext.resume(),e?(CreateElementSource(e),currentElement=e,needInitAudio=!1):console.log("ERROR: no element on init")}function Inject(){var e=document.createElement("script");e.src=chrome.runtime.getURL("page.js"),e.onload=function(){this.remove()},(document.head||document.documentElement).appendChild(e),window.addEventListener("message",(function(e){if("object"==typeof e.data){var t=e.data;if("AUDIO_ELEMENT_EVENT"===t.type){var a=window.document.getElementById(t.audioId);if("play"===t.eventType)needInitAudio&&InitAudio(a),currentElement!=a&&(currentElement=a,htmlElementSource!==a.src&&(DestroyElementSource(),audioElementSource=null,htmlElementSource=a.src),CreateElementSource(a))}}}))}function GetControlPanelContent(e){return'\t<div class="custom_combobox">\t\t<label class="custom_combobox_label" for="style_select" data-locale="label_style">Style</label>\t\t<select id="style_select" class="custom_select style_select">\t\t\t<option value="sinewave">Waves</option>\t\t\t<option value="frequencybars">Bars</option>\t\t\t<option value="radial">Radial</option>\t\t\t<option value="lumibars">LumiBars</option>\t\t\t<option value="fillzone">FillZone</option>\t\t\t<option value="led">LED</option>\t\t</select>\t</div>\t<div class="custom_combobox">\t\t<label class="custom_combobox_label" for="theme_select" data-locale="label_theme">Theme</label>\t\t<select id="theme_select" class="custom_select theme_select">\t\t\t<option value="vktheme">VK</option>\t\t\t<option value="rgbtheme">RGB</option>\t\t</select>\t</div>\t<label class="custom_checkbox custom_checkbox_label">\t\t<span data-locale="label_opacity">Opacity</span>\t\t<input type="checkbox" id="switchOpacity" class="opacity_switch" checked="checked">\t\t<span class="checkmark"></span>\t</label>\t<div class="custom_combobox">\t\t<label class="custom_combobox_label" for="range_select_from" data-locale="label_range">Range(Hz)</label>\t\t<br/>\t\t<select class="custom_select range_part_from">\t\t\t<option value="10">10</option>\t\t\t<option value="20">20</option>\t\t\t<option value="50">50</option>\t\t\t<option value="100">100</option>\t\t\t<option value="500">500</option>\t\t\t<option value="1000">1K</option>\t\t\t<option value="5000">5K</option>\t\t\t<option value="10000">10K</option>\t\t\t<option value="15000">15K</option>\t\t\t<option value="20000">20K</option>\t\t\t<option value="22000">22K</option>\t\t</select>\t\t<span style="padding-left: 4px">-</span>\t\t<select class="custom_select range_part_to">\t\t\t<option value="10">10</option>\t\t\t<option value="20">20</option>\t\t\t<option value="50">50</option>\t\t\t<option value="100">100</option>\t\t\t<option value="500">500</option>\t\t\t<option value="1000">1K</option>\t\t\t<option value="5000">5K</option>\t\t\t<option value="10000">10K</option>\t\t\t<option value="15000">15K</option>\t\t\t<option value="20000">20K</option>\t\t\t<option value="22000">22K</option>\t\t</select>\t</div>\t<span class="support_link">\t\t<a target="_blank" rel="noopener noreferrer" href="https://docs.google.com/document/d/1358mdPy5sHWpi-nRCqLnCa3mxB0GN40wF47XrXwLPmA/edit?usp=sharing" data-locale="support_link">Support</a>\t</span>'}function OnChangeOptions(e){visualizers.forEach((function(t){if(e&&t.element.id==e.element.id)return;const a=t.index;var r=t.element.querySelector("#control_panel"+a);r.querySelector(".style_select").value=globalVars.settings.visType,r.querySelector(".theme_select").value=globalVars.settings.theme,r.querySelector(".opacity_switch").checked=globalVars.settings.useOpacity,r.querySelector(".range_part_from").value=globalVars.settings.minFreq,r.querySelector(".range_part_to").value=globalVars.settings.maxFreq}))}function OnSettingsChanged(){OnChangeOptions(null),visualizers.forEach((function(e){e.vars.needInit=!0})),chrome.runtime.sendMessage({action:"set-settings",settings:globalVars.settings},(function(){}))}function CreateVisualizer(e){var t=document.createElement("div");t.id="visualizer_container_"+vizIndex,t.className="visualizer_container",t.setAttribute("style","height:"+VisualizerHeight+"px");var a=document.createElement("div");a.id="visualizer"+vizIndex,a.className="visualizer";var r=document.createElement("canvas");r.id="canvas"+vizIndex,r.className="canvas";var n=r.getContext("2d");a.appendChild(r),r.width=e.offsetWidth-155;var s=document.createElement("div");s.id="control_panel"+vizIndex,s.className="control_panel",a.appendChild(s),s.innerHTML=GetControlPanelContent(vizIndex);var o=s.querySelector(".style_select");o.value=globalVars.settings.visType,o.addEventListener("change",(e=>{const t=e.currentTarget.value;ApplyVisualType(globalVars,t)}));var i=s.querySelector(".theme_select");i.value=globalVars.settings.theme,i.addEventListener("change",(e=>{const t=e.currentTarget.value;ApplyThemeParams(globalVars,t)}));var l=s.querySelector(".opacity_switch");l.checked=globalVars.settings.useOpacity,l.addEventListener("change",(e=>{globalVars.settings.useOpacity=!globalVars.settings.useOpacity,OnSettingsChanged()}));var c=s.querySelector(".range_part_from");c.value=globalVars.settings.minFreq,c.addEventListener("change",(e=>{globalVars.settings.minFreq=parseInt(e.currentTarget.value,10),OnSettingsChanged()}));var v=s.querySelector(".range_part_to");v.value=globalVars.settings.maxFreq,v.addEventListener("change",(e=>{globalVars.settings.maxFreq=parseInt(e.currentTarget.value,10),OnSettingsChanged()})),t.appendChild(a);var g={index:vizIndex,element:t,canvas:r,context:n,vars:{dataArray:null,bufferLength:0,needInit:!0}};return++vizIndex,DrawAll(globalVars,g),g}var mainPlayerParent,topPlayerObserver=null,attachObserver=null,detachObserver=null;function TryToAttachVisualizer(e,t){if(!e)return console.error("Player container not found"),!1;if(null!=e.querySelector(".visualizer_container"))return!1;var a=e;t||(a=e=e.querySelector('div[data-testid^="audioplayerblocksectionslayout"]').parentNode);var r=CreateVisualizer(a);return visualizers.push(r),e.insertBefore(r.element,e.firstChild),localize(),!0}function ObserveMainPlayerDetached(){mainPlayerParent=document.querySelector("#page_body"),detachObserver||(detachObserver=new MutationObserver((function(e){e.forEach((function(e){e.removedNodes.forEach((function(e){e&&e.classList&&e.classList.contains("_audio_page_player_wrap")&&(detachObserver.disconnect(),detachObserver=null,ObserveMainPlayerAttached())}))}))}))).observe(mainPlayerParent,{childList:!0,subtree:!0})}function ObserveMainPlayerAttached(){mainPlayerParent=document.querySelector("#page_body"),attachObserver||(attachObserver=new MutationObserver((function(e){var t=!1;if(e.forEach((function(e){e.addedNodes.length&&(t=!0)})),t){var a=mainPlayerParent.querySelector(".AudioPlayerBlock__root");a&&TryToAttachVisualizer(a,!1)&&attachObserver.disconnect()}}))).observe(mainPlayerParent,{childList:!0,subtree:!0})}function InitContentForTopPlayer(){if(topPlayerParent=document.querySelector("#top_audio_layer_place")){var e=topPlayerParent.querySelector(".audio_layer_container");e?TryToAttachVisualizer(e=e.parentNode,!0):(topPlayerObserver=new MutationObserver((function(t){var a=!1;t.forEach((function(e){e.addedNodes.length&&(a=!0)})),a&&(e=topPlayerParent.querySelector(".audio_layer_container"))&&TryToAttachVisualizer(e=e.parentNode,!0)&&topPlayerObserver.disconnect()}))).observe(topPlayerParent,{childList:!0,subtree:!0})}else console.error("Failed to find top player place")}function InitContent(){chrome.runtime.sendMessage({action:"query-active-tab"},(e=>{tabId=e.id})),chrome.runtime.sendMessage({action:"get-settings"},(function(e){ApplySettings(globalVars,e),InitContentForTopPlayer(),ObserveMainPlayerAttached()}))}